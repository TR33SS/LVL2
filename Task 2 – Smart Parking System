// ================= BLYNK CONFIGURATION =================
// These details link the ESP32 to your Blynk project
#define BLYNK_TEMPLATE_ID "NAMASTE"
#define BLYNK_TEMPLATE_NAME "HI"
#define BLYNK_AUTH_TOKEN "HELLO"

// ================= REQUIRED LIBRARIES =================
#include <WiFi.h>
#include <BlynkSimpleEsp32.h>

// ================= WIFI CREDENTIALS =================
// Used to connect ESP32 to the internet
char ssid[] = "WORD";
char pass[] = "PASS";

// ================= ULTRASONIC SENSOR PINS =================
// Parking Slot 1
#define TRIG1 5
#define ECHO1 18

// Parking Slot 2
#define TRIG2 22
#define ECHO2 23

// ================= DISTANCE MEASUREMENT FUNCTION =================
// This function triggers the ultrasonic sensor and calculates distance
long getDistance(int trigPin, int echoPin) {
  digitalWrite(trigPin, LOW);
  delayMicroseconds(2);

  // Send ultrasonic pulse
  digitalWrite(trigPin, HIGH);
  delayMicroseconds(10);
  digitalWrite(trigPin, LOW);

  // Measure time taken for echo to return
  long duration = pulseIn(echoPin, HIGH, 30000); // Timeout at 30ms

  // Convert time to distance in centimeters
  return duration / 58;
}

void setup() {
  // Start serial communication for debugging
  Serial.begin(115200);

  // Set ultrasonic pins
  pinMode(TRIG1, OUTPUT);
  pinMode(ECHO1, INPUT);
  pinMode(TRIG2, OUTPUT);
  pinMode(ECHO2, INPUT);

  // Connect ESP32 to Blynk cloud
  Blynk.begin(BLYNK_AUTH_TOKEN, ssid, pass);
}

void loop() {
  // Required for Blynk communication
  Blynk.run();

  // ================= PARKING SLOT 1 =================
  long dist1 = getDistance(TRIG1, ECHO1);
  Serial.print("Sensor 1 Distance: ");
  Serial.println(dist1);

  // If car detected within 40 cm
  if (dist1 > 0 && dist1 < 40) {
    Blynk.virtualWrite(V0, 255);           // Turn ON LED widget
    Blynk.virtualWrite(V8, "Seat Occupied");
  } else {
    Blynk.virtualWrite(V0, 0);             // Turn OFF LED widget
    Blynk.virtualWrite(V8, "Not Occupied");
  }

  // ================= PARKING SLOT 2 =================
  long dist2 = getDistance(TRIG2, ECHO2);
  Serial.print("Sensor 2 Distance: ");
  Serial.println(dist2);

  if (dist2 > 0 && dist2 < 40) {
    Blynk.virtualWrite(V1, 255);           // Turn ON LED widget
    Blynk.virtualWrite(V5, "Seat Occupied");
  } else {
    Blynk.virtualWrite(V1, 0);             // Turn OFF LED widget
    Blynk.virtualWrite(V5, "Not Occupied");
  }

  // Delay to prevent excessive sensor triggering
  delay(1000);
}
