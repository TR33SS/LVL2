//PART1

// ================= REQUIRED LIBRARIES =================
// SPI library for communication with RFID module
#include <SPI.h>

// MFRC522 library for RFID reader
#include <MFRC522.h>

// ================= PIN DEFINITIONS =================
// Reset pin of RFID module
#define RST_PIN 22

// Slave Select (SDA) pin of RFID module
#define SS_PIN 21

// Create RFID reader object
MFRC522 rfid(SS_PIN, RST_PIN);

void setup() {
  // Start serial communication
  Serial.begin(115200);

  // Initialize SPI bus
  SPI.begin();

  // Initialize RFID reader
  rfid.PCD_Init();

  // Prompt user
  Serial.println("Scan an RFID card...");
}

void loop() {
  // Check if a new RFID card is present
  if (!rfid.PICC_IsNewCardPresent()) return;

  // Try to read the card UID
  if (!rfid.PICC_ReadCardSerial()) return;

  // Print UID in hexadecimal format
  Serial.print("Card UID: ");
  for (byte i = 0; i < rfid.uid.size; i++) {
    // Add leading zero if needed
    Serial.print(rfid.uid.uidByte[i] < 0x10 ? "0" : "");
    Serial.print(rfid.uid.uidByte[i], HEX);
  }
  Serial.println();

  // Delay to prevent multiple readings of same card
  delay(1500);
}

//PART2

// ================= REQUIRED LIBRARIES =================
#include <WiFi.h>         // WiFi connectivity
#include <HTTPClient.h>   // HTTP POST requests
#include <SPI.h>          // SPI communication
#include <MFRC522.h>      // RFID reader library

// ================= RFID PIN DEFINITIONS =================
#define SS_PIN 21   // SDA pin
#define RST_PIN 22  // Reset pin

// ================= WIFI CREDENTIALS =================
const char* ssid = "YOUR_WIFI_SSID";
const char* password = "YOUR_WIFI_PASSWORD";

// Google Apps Script Web App URL
const String scriptURL = "YOUR_SCRIPT_WEB_APP_URL";

// Create RFID reader object
MFRC522 rfid(SS_PIN, RST_PIN);

void setup() {
  // Start serial communication
  Serial.begin(115200);

  // Initialize SPI and RFID reader
  SPI.begin();
  rfid.PCD_Init();

  // Connect to WiFi
  WiFi.begin(ssid, password);
  Serial.print("Connecting to WiFi");

  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
    Serial.print(".");
  }

  Serial.println("\nConnected to WiFi!");
  Serial.println("Scan RFID card to log attendance...");
}

void loop() {
  // Check for new RFID card
  if (!rfid.PICC_IsNewCardPresent()) return;
  if (!rfid.PICC_ReadCardSerial()) return;

  // Convert UID to readable string
  String uid = "";
  for (byte i = 0; i < rfid.uid.size; i++) {
    uid += (rfid.uid.uidByte[i] < 0x10 ? "0" : "");
    uid += String(rfid.uid.uidByte[i], HEX);
  }
  uid.toUpperCase();

  // Display UID on serial monitor
  Serial.println("Card UID: " + uid);

  // Send attendance data to Google Sheets
  sendDataToGoogleSheet(uid, "Present");

  // Delay to avoid duplicate entries
  delay(3000);
}

// ================= FUNCTION TO SEND DATA TO GOOGLE SHEETS =================
void sendDataToGoogleSheet(String uid, String status) {
  if (WiFi.status() == WL_CONNECTED) {
    HTTPClient http;

    // Connect to Google Apps Script
    http.begin(scriptURL);
    http.addHeader("Content-Type", "application/json");

    // Create JSON payload
    String json = "{\"uid\":\"" + uid + "\", \"status\":\"" + status + "\"}";

    // Send POST request
    int httpCode = http.POST(json);

    if (httpCode > 0) {
      Serial.println("Attendance logged successfully.");
    } else {
      Serial.print("Error sending data. Code: ");
      Serial.println(httpCode);
    }

    http.end();
  } else {
    Serial.println("WiFi not connected");
  }
}

